{% extends "index/base.jinja2" %}
{% block content %}
{% block imports %}
{% endblock %}
<script src = "{{url_for('static', filename = 'js/back_testing.js')}}"></script>
<script>

var stock_data = {}
var tickers = [];
var amounts = [];

$(document).ready = on_load({{g.user['user_id']}});
function getRandomColor() {
    var letters = '0123456789ABCDEF';
    var color = '#';
    for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}

function on_load(user_id){
    $.getJSON('/api/portfolios?user_id=' + user_id, function(data){
        amounts = data['amount'];
        tickers = data['ticker'];
        for (let i = 0; i < amounts.length; i++){
            stock_data[tickers[i]] = amounts[i];
        }
    }).done(function (){
        let arr = [];
        arr.sort();
        for (ticker in stock_data){
            arr.push("<li class=\"list-group-item\">"+ ticker + " (amount: " + stock_data[ticker]+")</li>" );
        };

        var args_String = arr.join('');
        document.getElementById('lol').innerHTML = args_String;
        var colors = ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"];
        for (let i = 5; i < tickers.length; i++){
            colors.push(getRandomColor());
        }
        new Chart(document.getElementById("doughnut-chart"), {
            type: 'doughnut',
            data: {
            labels: tickers,
            datasets: [
                {
                label: "Value $(USD)",
                backgroundColor: colors.slice(0, tickers.length),
                data: amounts
                }
            ]
            },
            options: {
                responsive: false,
                title: {
                    display: true,
                    text: 'Distribution of Assets in your Portfolio'
                },
                legend: {
                    display: true,
                    labels: {
                        fontSize: 8,
                        boxWidth: 20
                    }
                }
            }
        });     
    });
}
</script>

<div class="card text-center" id = "card-page" style = "width: 70%; margin: 0 auto; padding: 20px 0; ">
    <div class = "card-header bg-light" style = "height: 15px !important"></div>
    <h3 style = "margin-top: 20px;"class="card-title">Your Current Portfolio of Assets</h3>
    <div style = "display: flex !important;justify-content: center; box-shadow: 0 !important;margin-bottom: 15px !important; padding: 20px 0;">
        <ul id = "lol" class = "list-group" style="margin-left: 10%; display: inline; width:40%; height:390px; overflow:hidden; overflow-y: scroll; text-align: left; border: 1px solid gray">
        </ul>
        <div style = "width: 55%; height = 55%;">
            <canvas id="doughnut-chart" style = "width:100% !important; height: 100% !important; margin-right: 0 !important;" h></canvas>
        </div>
    </div>
    
    <div style = "margin: 12px 0;">
        <input style = "width: 50%" type="text" name="daterange" class = "huh" placeholder = "Click here to select a range of dates to backtest from!" />
    </div>
    <div style = "margin-bottom: 20px;">
        <a style = "width: 50%" href="{{url_for('index.set_portfolio')}}" class="btn btn-info">Edit Portfolio</a>
        {# pass in scoped current portfolio along with time window from input to backtest #}
        <a style = "width: 50%"  class="btn btn-danger" onclick = "backtest({{g.user['user_id']}})">Backtest your portfolio on this time interval</a>
        <a style = "width: 50%"  class="btn btn-success" onclick = "generate_better({{g.user['user_id']}})">Generate a better portfolio on this time interval</a>
    
    </div>
    <div style = "height: 25px" class = "card-footer text-muted"></div>
</div>

{% endblock %}